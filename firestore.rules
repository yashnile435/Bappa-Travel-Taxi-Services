rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // Helper function to check if user is authenticated
    function isAuthenticated() {
      return request.auth != null;
    }
    
    // Helper function to check if user is admin
    function isAdmin() {
      return isAuthenticated() && 
             get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
    }
    
    // Helper function to check if user owns the resource
    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }
    
    // Helper function to validate email format
    function isValidEmail(email) {
      return email.matches('^[a-zA-Z0-9._-]+@[a-zA-Z0-9.-]+\\.[a-zA-Z]{2,6}$');
    }
    
    // Helper function to validate mobile format
    function isValidMobile(mobile) {
      return mobile.matches('^[0-9]{10}$');
    }
    
    // Users collection - users can only read/write their own data
    match /users/{userId} {
      // Allow read if user is authenticated and reading their own data OR is admin
      allow read: if isOwner(userId) || isAdmin();
      
      // Allow create only if authenticated and creating their own document
      allow create: if isAuthenticated() && 
                       request.auth.uid == userId &&
                       request.resource.data.uid == userId &&
                       isValidEmail(request.resource.data.email) &&
                       (request.resource.data.mobile == '' || isValidMobile(request.resource.data.mobile)) &&
                       request.resource.data.name.size() >= 2 &&
                       request.resource.data.name.size() <= 100;
      
      // Allow update only if user owns the document OR is admin
      // Users cannot change their own role
      allow update: if (isOwner(userId) && 
                        (!request.resource.data.diff(resource.data).affectedKeys().hasAny(['role', 'uid']))) ||
                       isAdmin();
      
      // Only admin can delete users
      allow delete: if isAdmin();
    }
    
    // Bookings collection - users can only access their own bookings
    match /bookings/{bookingId} {
      // Allow read if user owns the booking OR is admin
      allow read: if isAuthenticated() && 
                     (resource.data.userId == request.auth.uid || isAdmin());
      
      // Allow create only if authenticated and creating booking for themselves
      allow create: if isAuthenticated() && 
                       request.resource.data.userId == request.auth.uid &&
                       request.resource.data.keys().hasAll(['userId', 'carId', 'pickupLocation', 'dropLocation', 'pickupDate', 'status']) &&
                       request.resource.data.pickupLocation.size() >= 3 &&
                       request.resource.data.dropLocation.size() >= 3 &&
                       request.resource.data.status in ['pending', 'confirmed', 'completed', 'cancelled'];
      
      // Allow update if user owns the booking OR is admin
      // Users can only update certain fields
      allow update: if isAuthenticated() && 
                       (resource.data.userId == request.auth.uid && 
                        request.resource.data.diff(resource.data).affectedKeys().hasOnly(['status', 'pickupLocation', 'dropLocation', 'pickupDate', 'pickupTime']) ||
                        isAdmin());
      
      // Allow delete if user owns the booking OR is admin
      allow delete: if isAuthenticated() && 
                       (resource.data.userId == request.auth.uid || isAdmin());
    }
    
    // Cars collection - read for all authenticated users, write only for admin
    match /cars/{carId} {
      // Allow read for all authenticated users
      allow read: if isAuthenticated();
      
      // Only admin can create, update, or delete cars
      allow create: if isAdmin() &&
                       request.resource.data.keys().hasAll(['name', 'description', 'passengers', 'status', 'imageUrl']) &&
                       request.resource.data.name.size() >= 2 &&
                       request.resource.data.name.size() <= 100 &&
                       request.resource.data.passengers is int &&
                       request.resource.data.passengers > 0 &&
                       request.resource.data.status in ['available', 'unavailable'];
      
      allow update: if isAdmin();
      allow delete: if isAdmin();
    }
    
    // Contact messages collection
    match /contacts/{contactId} {
      // Anyone can create a contact message
      allow create: if request.resource.data.keys().hasAll(['name', 'email', 'message', 'timestamp']) &&
                       request.resource.data.name.size() >= 2 &&
                       request.resource.data.name.size() <= 100 &&
                       isValidEmail(request.resource.data.email) &&
                       request.resource.data.message.size() >= 10 &&
                       request.resource.data.message.size() <= 1000;
      
      // Only admin can read, update, or delete contact messages
      allow read, update, delete: if isAdmin();
    }
    
    // Admin-specific collections
    match /admin/{document=**} {
      // Only admin can access admin collections
      allow read, write: if isAdmin();
    }
    
    // Deny all other access
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
